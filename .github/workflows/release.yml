name: Release

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "是否创建 Release"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

  pull_request:
    types: [closed]
    branches:
      - dev
      - main

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.pull_request.merged == true

    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      MIN_RELEASE_COMMITS: 3

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-node@v6
        with:
          node-version: 24

      - run: npm ci
      - run: npm run build

      - name: Resolve Base Version
        id: base
        run: |
          BASE=$(node -p "require('./package.json').version")
          echo "base=$BASE" >> $GITHUB_OUTPUT

      - name: Resolve Channel Version
        id: version
        run: |
          BASE="${{ steps.base.outputs.base }}"
          SHA=$(git rev-parse --short HEAD)

          git fetch --tags

          if [ "${GITHUB_REF_NAME}" = "dev" ]; then
            LAST=$(git tag -l "v${BASE}-beta.*" | sort -V | tail -n 1)

            if [ -z "$LAST" ]; then
              N=0
            else
              N=$(echo "$LAST" | sed -E 's/.*-beta\.([0-9]+).*/\1/')
            fi

            VERSION="${BASE}-beta.$((N + 1))+${SHA}"
            PRERELEASE=true
          else
            VERSION="${BASE}"
            PRERELEASE=false
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

      - name: Inject Version Header
        run: |
          awk -v ver="${{ steps.version.outputs.version }}" '
          BEGIN { found=0 }
          /@version/ {
            print "// @version " ver
            found=1
            next
          }
          { print }
          END {
            if (!found) print "// @version " ver
          }' dist/EdgeDL.user.js > dist/EdgeDL.tmp \
          && mv dist/EdgeDL.tmp dist/EdgeDL.user.js

      - name: Create Release
        if: |
          github.event.inputs.publish == 'true' ||
          github.event.pull_request.merged == true

        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          files: dist/EdgeDL.user.js
          prerelease: ${{ steps.version.outputs.prerelease }}
          generate_release_notes: true
